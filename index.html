<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>מעקב טאבלטים — בזמן אמת</title>
  <meta name="theme-color" content="#146EFF">
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
            --blue:#2563eb; --red:#dc2626; --green:#22c55e; --yellow:#f59e0b; --radius:14px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text);
          font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans", sans-serif;
          -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
          font-size:18px; line-height:1.35; -webkit-tap-highlight-color:transparent; }
    .container{max-width:960px;margin:0 auto;padding:16px 16px 112px}
    .header{ position:sticky; top:0; z-index:10; background:rgba(246,247,251,.9); backdrop-filter:saturate(1.2) blur(6px);
              padding:10px 0 12px; margin:0 0 8px; border-bottom:1px solid var(--border);}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
    h1{font-size:24px; margin:0; font-weight:800}
    .btn{appearance:none; border:1px solid var(--border); background:#fff; color:#111827; padding:10px 12px; border-radius:12px; font-size:18px; cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--blue); border-color:var(--blue); color:#fff}
    .btn.danger{background:var(--red); border-color:var(--red); color:#fff}
    .btn.outline{background:#fff}
    .btn.sm{font-size:16px; padding:8px 10px}
    .btn.lg{font-size:18px; padding:12px 14px}
    .input{width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; font-size:18px}
    .stack{display:grid; gap:10px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .grid-2{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .stat{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:12px; text-align:center}
    .stat .label{font-size:14px;color:var(--muted)} .stat .num{font-size:22px;font-weight:800}
    .chip{display:inline-block; padding:2px 10px; border-radius:9999px; font-size:12px}
    .chip.green{background:#dcfce7;color:#065f46} .chip.gray{background:#eef2f7;color:#1f2937} .chip.yellow{background:#fef9c3;color:#92400e}
    .seg{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .seg button{border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer}
    .seg button.active{background:var(--blue); color:#fff; border-color:var(--blue)}
    .cards{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    @media (min-width:640px){ .cards{grid-template-columns:repeat(3,minmax(0,1fr));} }
    .card{border:1px solid var(--border); border-radius:var(--radius); padding:12px; background:#fff}
    .purchased{background:#dcfce7} .unused{background:#f3f4f6} .maint{background:#fff7ד6}
    .card .title{font-weight:700; font-size:18px} .card .row{margin-top:10px}
    .footer{position:sticky; bottom:0; background:#fff; border-top:1px solid var(--border); padding:10px; z-index:9}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .overlay.show{display:flex} .modal{background:#fff; border-radius:16px; padding:16px; width:100%; max-width:480px; max-height:85vh; overflow:auto; border:1px solid var(--border)}
    .modal .header{position:static; background:#fff; border:none; padding:0; margin:0 0 8px}
    .err{position:fixed; inset-inline:0; bottom:0; display:none; z-index:60} .err .box{margin:10px auto; max-width:960px; background:#dc2626; color:#fff; padding:10px 12px; border-radius:12px; font-size:14px}
    .muted{color:var(--muted); font-size:14px} .legend{display:flex; gap:10px; align-items:center; font-size:14px; color:var(--muted)} .legend .chip{font-size:12px}
  </style>
</head>
<body>
<main class="container" id="root">

  <section id="app">
    <header class="header">
      <div class="row">
        <div class="row">
          <h1>מעקב טאבלטים</h1>
          <button id="btnHelp" class="btn sm" title="עזרה">❓</button>
        </div>
        <div class="row">
          <button id="btnMaint" class="btn sm">מצב תחזוקה</button>
          <button id="btnReset" class="btn sm danger">איפוס יום</button>
        </div>
      </div>

      <div class="grid-3" style="margin-top:10px">
        <div class="stat"><div class="label">התבצעו עסקאות</div><div id="countPurchased" class="num">0</div></div>
        <div class="stat"><div class="label">לא התבצעו עסקאות</div><div id="countUnused" class="num">0</div></div>
        <div class="stat"><div class="label">תחזוקה</div><div id="countMaint" class="num">0</div></div>
      </div>

      <div class="legend" style="margin-top:10px">
        <span class="chip green">התבצעה עסקה</span>
        <span class="chip gray">לא התבצעה עסקה</span>
        <span class="chip yellow">תחזוקה (מוסתר)</span>
      </div>

      <div class="seg" style="margin-top:10px">
        <button data-filter="purchased">התבצעה עסקה</button>
        <button data-filter="not">לא התבצעה עסקה</button>
        <button data-filter="all" class="active">הכל</button>
      </div>

      <input id="searchInput" class="input" placeholder="חיפוש מספר טאבלט" style="margin-top:10px" />
      <div id="status" class="muted" style="margin-top:4px">מתחבר…</div>
      <div id="rangeNote" class="muted" style="margin-top:6px">טווח הטאבלטים: #51–#99</div>
    </header>

    <section style="margin-top:12px">
      <div id="cards" class="cards"></div>
    </section>

    <div class="footer">
      <div class="grid-2">
        <button id="btnExport" class="btn outline lg">ייצוא CSV</button>
        <button id="btnMaint2" class="btn lg">מצב תחזוקה</button>
      </div>
    </div>
  </section>
</main>

<!-- מודל תחזוקה -->
<div id="maintModal" class="overlay">
  <div class="modal">
    <div class="header">
      <div class="row">
        <h2 style="margin:0;font-size:20px">מצב תחזוקה</h2>
        <button id="maintClose" class="btn sm">סגור</button>
      </div>
    </div>
    <p class="muted">מצב תחזוקה מסתיר טאבלט מהרשימה הראשית ולא סופרים אותו.</p>
    <div id="maintPinWrap" class="stack" style="margin-top:10px">
      <input id="maintPin" inputmode="numeric" maxlength="4" class="input" placeholder="הכנס קוד PIN" />
      <button id="maintPinOk" class="btn primary lg">כניסה</button>
      <div class="muted">ברירת מחדל: 4321</div>
    </div>
    <div id="maintBody" class="stack" style="display:none; margin-top:10px">
      <input id="maintSearch" class="input" placeholder="חיפוש מספר טאבלט" />
      <div id="maintCards" class="cards" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- מודל אישור -->
<div id="confirmModal" class="overlay">
  <div class="modal">
    <h3 style="margin:0 0 8px;font-size:18px">לבטל עסקה עבור טאבלט זה?</h3>
    <div class="grid-2" style="margin-top:10px">
      <button id="confirmToUnused" class="btn lg">בטל עסקה</button>
      <button id="confirmCancel" class="btn outline lg">ביטול</button>
    </div>
  </div>
</div>

<!-- מודל עזרה -->
<div id="helpModal" class="overlay">
  <div class="modal">
    <h2 style="margin:0 0 8px;font-size:20px">איך עובדים?</h2>
    <ol style="margin:0 0 12px 0; padding: 0 22px; font-size:14px; color:var(--muted)">
      <li>הרשימה כוללת את הטאבלטים #51–#99 בלבד.</li>
      <li>כדי לסמן עסקה: לחץ על <b>סמן כהתבצעה עסקה</b>. אפשר לפלטר לפי התבצעה/לא.</li>
      <li>כדי לבטל עסקה: לחץ <b>סמן כלא התבצעה עסקה</b> ותופיע בקשת אישור.</li>
      <li>כדי להכניס/להוציא מתחזוקה: פתח <b>מצב תחזוקה</b> (עם PIN).</li>
      <li>כדי לאפס את היום: <b>איפוס יום</b> (עם PIN).</li>
    </ol>
    <button id="helpClose" class="btn primary lg" style="width:100%">הבנתי</button>
  </div>
</div>

<!-- באנר שגיאה למסך -->
<div id="errorBanner" class="err"><div class="box"></div></div>

<script type="module">
  const errorBanner=document.getElementById('errorBanner');
  function showError(msg){ const box=errorBanner.firstElementChild; box.textContent=msg; errorBanner.style.display='block'; setTimeout(()=>errorBanner.style.display='none',7000); }
  window.addEventListener('error',(e)=>showError(e.message||'שגיאה כללית'));
  window.addEventListener('unhandledrejection',(e)=>showError(e.reason?.message||'שגיאה כללית'));

  const DEFAULT_CONFIG = { firebase: {"apiKey": "AIzaSyAAZvh7mH9z7Se1uUwIJg9G4bOEf9oD5Ec", "authDomain": "tablets-tracker-835e3.firebaseapp.com", "projectId": "tablets-tracker-835e3", "storageBucket": "tablets-tracker-835e3.firebasestorage.app", "messagingSenderId": "774676558822", "appId": "1:774676558822:web:b008720d77026be5d1dc27", "measurementId": "G-W4S6LFF6G5"}, orgId: "main" };
  let cfg = DEFAULT_CONFIG;
  const RESET_PIN='4321';
  const RANGE_START=51, RANGE_END=99;
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const statusEl=document.getElementById('status');

  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
  const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
  const { getFirestore, doc, getDocs, updateDoc, collection, onSnapshot, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');

  const app = initializeApp(cfg.firebase);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const todayISO=()=>{ const d=new Date(); const tz=d.getTimezoneOffset(); return new Date(d - tz*60000).toISOString().slice(0,10); };
  const today=todayISO();
  const dayCol = collection(db,'orgs', cfg.orgId, 'days', today, 'tablets');
  const dayDoc = (id)=> doc(db,'orgs', cfg.orgId, 'days', today, 'tablets', String(id));

  let unsubscribe=null; let cache=new Map();

  async function ensureToday(){
    const snap=await getDocs(dayCol);
    if (!snap.empty) return;
    const batch=writeBatch(db);
    for (let n=RANGE_START; n<=RANGE_END; n++){ batch.set(dayDoc(n), { status:'unused', updatedAt: Date.now() }); }
    await batch.commit();
  }

  function recalcCounters(){
    let purchased=0, maint=0, unused=0;
    for (const [,v] of cache){ if(v.status==='purchased') purchased++; else if(v.status==='maint') maint++; else unused++; }
    document.getElementById('countPurchased').textContent=purchased;
    document.getElementById('countMaint').textContent=maint;
    document.getElementById('countUnused').textContent=unused;
  }

  function setActiveFilter(val){ $$('.seg button').forEach(b=>b.classList.toggle('active', b.dataset.filter===val)); }

  function render(){
    const activeBtn=document.querySelector('.seg button.active'); const filter=(activeBtn?activeBtn.dataset.filter:'all');
    const search=document.getElementById('searchInput').value.trim().toLowerCase();
    const container=document.getElementById('cards'); container.innerHTML='';
    const entries=[...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0]));
    for (const [id, info] of entries){
      if (info.status==='maint') continue;
      const pass=(filter==='all')||(filter==='purchased'&&info.status==='purchased')||(filter==='not'&&info.status==='unused');
      const match=!search || String(id).includes(search);
      if (!pass || !match) continue;
      const cls=(info.status==='purchased')?'purchased':'unused';
      const chip=(cls==='purchased')?'<span class="chip green">התבצעה עסקה</span>':'<span class="chip gray">לא התבצעה עסקה</span>';
      const card=document.createElement('div'); card.className='card '+cls;
      card.innerHTML=`
        <div class="row"><div class="title">#${id}</div>${chip}</div>
        <div class="grid-2" style="margin-top:10px">
          <button class="btn lg btnStatus" data-id="${id}" data-next="purchased">סמן כהתבצעה עסקה</button>
          <button class="btn lg btnStatus" data-id="${id}" data-next="unused">סמן כלא התבצעה עסקה</button>
        </div>`;
      container.appendChild(card);
    }
    container.querySelectorAll('.btnStatus').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id=e.currentTarget.getAttribute('data-id');
        const next=e.currentTarget.getAttribute('data-next');
        const current=(cache.get(id)?.status||'unused');
        if (current==='purchased' && next==='unused'){ openConfirm(id); return; }
        try{ await updateDoc(dayDoc(id), { status: next, updatedAt: Date.now() }); }catch(err){ showError('עדכון נכשל'); }
      });
    });
  }

  let confirmId=null;
  function openConfirm(id){ confirmId=id; document.getElementById('confirmModal').classList.add('show'); }
  document.getElementById('confirmCancel').addEventListener('click', ()=> document.getElementById('confirmModal').classList.remove('show'));
  document.getElementById('confirmToUnused').addEventListener('click', async ()=>{ if(!confirmId) return; try{ await updateDoc(dayDoc(confirmId), { status:'unused', updatedAt: Date.now() }); }catch{} document.getElementById('confirmModal').classList.remove('show'); confirmId=null; });

  async function subscribe(){
    if (unsubscribe) unsubscribe();
    statusEl.textContent='טוען את היום…';
    await ensureToday();
    unsubscribe=onSnapshot(dayCol, (snap)=>{
      const map=new Map(); snap.forEach(s=>{ const d=s.data(); map.set(s.id, { status:d.status||'unused' }); });
      cache=map; statusEl.textContent=`מחובר — ${map.size} טאבלטים`; recalcCounters(); render();
    }, (err)=>{ console.error(err); statusEl.textContent='שגיאה: לא ניתן להתחבר.'; showError('שגיאה ב-Firestore'); });
  }

  function exportCSV(){
    const t=new Date().toISOString().slice(0,10);
    const rows=[["date","tablet","status"]];
    for (const [id, info] of [...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0])) ) rows.push([t,id,info.status]);
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`tablet-tracker-${t}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  async function resetDay(){
    const pin=prompt('הכנס PIN:'); if(pin!=='4321'){ alert('PIN שגוי'); return; }
    if(!confirm('לאפס את היום לכל הטאבלטים?')) return;
    try{ const snap=await getDocs(dayCol); const { writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
      const batch=writeBatch(db); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await ensureToday(); alert('האיפוס הושלם.'); }
    catch(e){ showError('האיפוס נכשל'); }
  }

  function openMaint(){ document.getElementById('maintModal').classList.add('show'); document.getElementById('maintPinWrap').style.display='grid'; document.getElementById('maintBody').style.display='none'; }
  function closeMaint(){ document.getElementById('maintModal').classList.remove('show'); }
  document.getElementById('maintClose').addEventListener('click', closeMaint);
  document.getElementById('maintPinOk').addEventListener('click', ()=>{ const val=document.getElementById('maintPin').value.trim();
    if(val!=='4321'){ alert('PIN שגוי'); return; } document.getElementById('maintPinWrap').style.display='none'; document.getElementById('maintBody').style.display='grid'; renderMaint(); });

  function renderMaint(){
    const q=document.getElementById('maintSearch').value.trim().toLowerCase();
    const cont=document.getElementById('maintCards'); cont.innerHTML='';
    const entries=[...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0]));
    for (const [id, info] of entries){
      if (q && !String(id).includes(q)) continue;
      const cls=(info.status==='maint')?'maint':'unused';
      const card=document.createElement('div'); card.className='card '+cls;
      card.innerHTML=`
        <div class="row">
          <div class="title">#${id}</div>
          <button class="btn sm btnMaintToggle" data-id="${id}">${info.status==='maint'?'הסר תחזוקה':'הכנס לתחזוקה'}</button>
        </div>
        <div class="muted" style="margin-top:6px">${info.status==='maint'?'🛠 במצב תחזוקה':'—'}</div>`;
      cont.appendChild(card);
    }
    cont.querySelectorAll('.btnMaintToggle').forEach(b=>{ b.addEventListener('click', async (e)=>{
      const id=e.currentTarget.getAttribute('data-id'); const curr=(cache.get(id)?.status||'unused'); const next=(curr==='maint')?'unused':'maint';
      try{ await updateDoc(dayDoc(id), { status: next, updatedAt: Date.now() }); }catch{ showError('עדכון נכשל'); }
    }); });
    document.getElementById('maintSearch').oninput=renderMaint;
  }

  $$('.seg button').forEach(b=>b.addEventListener('click',()=>{ setActiveFilter(b.dataset.filter); render(); }));
  document.getElementById('searchInput').addEventListener('input', render);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnReset').addEventListener('click', resetDay);
  document.getElementById('btnMaint').addEventListener('click', openMaint);
  document.getElementById('btnMaint2').addEventListener('click', openMaint);

  onAuthStateChanged(auth, async (user)=>{ if(!user){ statusEl.textContent='מתחבר…'; await signInAnonymously(auth); return; } subscribe(); });
</script>
</body>
</html>
