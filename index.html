<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>××¢×§×‘ ×˜××‘×œ×˜×™× â€” ×‘×–××Ÿ ×××ª</title>
  <meta name="theme-color" content="#00BCD4">
  <style>
    :root{ 
      --bg: #f8f9fa; 
      --card: #ffffff; 
      --text: #2c3e50; 
      --muted: #6c757d; 
      --border: #e9ecef;
      --teal: #00BCD4; 
      --teal-dark: #0097a7;
      --red: #e74c3c; 
      --green: #27ae60; 
      --yellow: #f39c12; 
      --radius: 12px; 
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    *{box-sizing:border-box} 
    html,body{height:100%; margin:0; padding:0}
    
    body{ 
      background:var(--bg); 
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans", sans-serif;
      -webkit-font-smoothing:antialiased; 
      -moz-osx-font-smoothing:grayscale;
      font-size:16px; 
      line-height:1.5; 
      -webkit-tap-highlight-color:transparent; 
    }
    
    .container{max-width:1200px;margin:0 auto;padding:0}
    
    /* Header */
    .header{ 
      background:var(--card); 
      border-bottom:1px solid var(--border);
      padding:12px 16px;
      position:sticky; 
      top:0; 
      z-index:100;
      box-shadow: var(--shadow);
    }
    
    .header-content{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:12px;
      max-width:1200px;
      margin:0 auto;
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .logo{
      width:40px;
      height:40px;
      background:var(--teal);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:bold;
      font-size:18px;
    }
    
    .brand-text h1{
      font-size:20px;
      margin:0;
      font-weight:700;
      color:var(--text);
    }
    
    .brand-text .subtitle{
      font-size:12px;
      color:var(--muted);
      margin:0;
    }
    
    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    /* Banner */
    .banner{
      background:linear-gradient(135deg, var(--teal), var(--teal-dark));
      color:white;
      padding:24px 16px;
      text-align:center;
    }
    
    .banner h2{
      font-size:24px;
      margin:0 0 8px 0;
      font-weight:700;
    }
    
    .banner p{
      font-size:14px;
      margin:0;
      opacity:0.9;
    }
    
    /* Stats */
    .stats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }
    
    .stat{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      text-align:center;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    
    .stat .num{
      font-size:28px;
      font-weight:800;
      color:var(--teal);
      margin-bottom:4px;
    }
    
    .stat .label{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }
    
    /* Controls */
    .controls{
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }
    
    .controls-row{
      display:flex;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    
    .seg{
      display:flex;
      background:var(--card);
      border-radius:var(--radius);
      padding:4px;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
      flex:1;
      min-width:200px;
    }
    
    .seg button{
      border:none;
      background:transparent;
      padding:8px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      color:var(--muted);
      transition:all 0.2s;
      flex:1;
      white-space:nowrap;
    }
    
    .seg button.active{
      background:var(--teal);
      color:white;
    }
    
    .search-box{
      flex:1;
      min-width:200px;
    }
    
    .input{
      width:100%;
      padding:12px 16px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      font-size:14px;
      box-shadow: var(--shadow);
    }
    
    .input:focus{
      outline:none;
      border-color:var(--teal);
      box-shadow: 0 0 0 3px rgba(0,188,212,0.1);
    }
    
    /* Cards Grid */
    .cards-container{
      padding:0 16px 32px;
      max-width:1200px;
      margin:0 auto;
    }
    
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
      gap:16px;
    }
    
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
      border:1px solid var(--border);
      transition:all 0.2s;
    }
    
    .card:hover{
      transform:translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .card.purchased{
      border-left:4px solid var(--green);
    }
    
    .card.unused{
      border-left:4px solid var(--muted);
    }
    
    .card.maint{
      border-left:4px solid var(--yellow);
      opacity:0.7;
    }
    
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    
    .card-title{
      font-size:20px;
      font-weight:700;
      color:var(--text);
    }
    
    .chip{
      padding:4px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
    }
    
    .chip.green{
      background:#d4edda;
      color:#155724;
    }
    
    .chip.gray{
      background:#e2e3e5;
      color:#383d41;
    }
    
    .chip.yellow{
      background:#fff3cd;
      color:#856404;
    }
    
    .card-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    
    .btn{
      border:none;
      padding:12px 16px;
      border-radius:var(--radius);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      text-align:center;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .btn:active{
      transform:translateY(1px);
    }
    
    .btn.primary{
      background:var(--teal);
      color:white;
    }
    
    .btn.primary:hover{
      background:var(--teal-dark);
    }
    
    .btn.outline{
      background:transparent;
      color:var(--teal);
      border:1px solid var(--teal);
    }
    
    .btn.outline:hover{
      background:var(--teal);
      color:white;
    }
    
    .btn.danger{
      background:var(--red);
      color:white;
    }
    
    .btn.danger:hover{
      background:#c0392b;
    }
    
    .btn.sm{
      padding:8px 12px;
      font-size:12px;
      min-height:36px;
    }
    
    /* Status */
    .status{
      text-align:center;
      padding:8px;
      font-size:14px;
      color:var(--muted);
    }
    
    /* Modals */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:1000;
      backdrop-filter:blur(4px);
    }
    
    .overlay.show{
      display:flex;
    }
    
    .modal{
      background:var(--card);
      border-radius:16px;
      padding:24px;
      width:100%;
      max-width:480px;
      max-height:85vh;
      overflow:auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    
    .modal h2{
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    
    .modal-close{
      background:none;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:var(--muted);
      padding:4px;
      min-height:32px;
      min-width:32px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    /* Error Banner */
    .error-banner{
      position:fixed;
      bottom:20px;
      left:16px;
      right:16px;
      background:var(--red);
      color:white;
      padding:12px 16px;
      border-radius:var(--radius);
      font-size:14px;
      display:none;
      z-index:60;
      box-shadow: 0 4px 16px rgba(231,76,60,0.3);
    }
    
    /* Loading */
    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px;
      color:var(--muted);
    }
    
    .spinner{
      width:20px;
      height:20px;
      border:2px solid var(--border);
      border-top:2px solid var(--teal);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-left:8px;
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    
    /* Mobile Responsive */
    @media (max-width:768px){
      .header-content{
        flex-direction:column;
        gap:16px;
        align-items:stretch;
      }
      
      .brand{
        justify-content:center;
      }
      
      .header-actions{
        justify-content:center;
        gap:8px;
      }
      
      .banner{
        padding:20px 16px;
      }
      
      .banner h2{
        font-size:20px;
      }
      
      .banner p{
        font-size:13px;
      }
      
      .stats{
        grid-template-columns:repeat(3,1fr);
        gap:8px;
        padding:12px;
      }
      
      .stat{
        padding:12px 8px;
      }
      
      .stat .num{
        font-size:20px;
      }
      
      .stat .label{
        font-size:11px;
      }
      
      .controls{
        padding:12px;
      }
      
      .controls-row{
        flex-direction:column;
        gap:12px;
      }
      
      .seg{
        min-width:auto;
      }
      
      .seg button{
        padding:10px 8px;
        font-size:13px;
      }
      
      .search-box{
        min-width:auto;
      }
      
      .cards-container{
        padding:0 12px 20px;
      }
      
      .cards{
        grid-template-columns:1fr;
        gap:12px;
      }
      
      .card{
        padding:16px;
      }
      
      .card-title{
        font-size:18px;
      }
      
      .card-actions{
        grid-template-columns:1fr;
        gap:8px;
      }
      
      .btn{
        padding:14px 16px;
        font-size:15px;
        min-height:48px;
      }
      
      .modal{
        margin:16px;
        padding:20px;
        max-height:80vh;
      }
      
      .error-banner{
        bottom:16px;
        left:12px;
        right:12px;
      }
    }
    
    @media (max-width:480px){
      .header{
        padding:8px 12px;
      }
      
      .brand-text h1{
        font-size:18px;
      }
      
      .brand-text .subtitle{
        font-size:11px;
      }
      
      .logo{
        width:36px;
        height:36px;
        font-size:16px;
      }
      
      .banner h2{
        font-size:18px;
      }
      
      .banner p{
        font-size:12px;
      }
      
      .stat .num{
        font-size:18px;
      }
      
      .stat .label{
        font-size:10px;
      }
      
      .card{
        padding:14px;
      }
      
      .card-title{
        font-size:16px;
      }
      
      .btn{
        padding:12px 14px;
        font-size:14px;
        min-height:44px;
      }
    }
  </style>
</head>
<body>
<main class="container" id="root">
  <section id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="brand">
          <div class="logo">ğŸ“±</div>
          <div class="brand-text">
            <h1>××¢×§×‘ ×˜××‘×œ×˜×™×</h1>
            <p class="subtitle">×‘×–××Ÿ ×××ª</p>
          </div>
        </div>
        <div class="header-actions">
          <button id="btnHelp" class="btn outline sm" title="×¢×–×¨×”">â“</button>
          <button id="btnExport" class="btn outline sm">×™×™×¦×•× CSV</button>
          <button id="btnMaint" class="btn outline sm">×ª×—×–×•×§×”</button>
          <button id="btnReset" class="btn danger sm">××™×¤×•×¡ ×™×•×</button>
        </div>
      </div>
    </header>

    <!-- Banner -->
    <div class="banner">
      <h2>××¢×§×‘ ×¢×¡×§××•×ª ×™×•××™</h2>
      <p>×¢×§×‘ ××—×¨×™ ×”×˜××‘×œ×˜×™× ×©×œ×š ×‘×–××Ÿ ×××ª â€¢ ×˜×•×•×— #51â€“#99</p>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div id="countPurchased" class="num">0</div>
        <div class="label">×”×ª×‘×¦×¢×• ×¢×¡×§××•×ª</div>
      </div>
      <div class="stat">
        <div id="countUnused" class="num">0</div>
        <div class="label">×œ× ×”×ª×‘×¦×¢×• ×¢×¡×§××•×ª</div>
      </div>
      <div class="stat">
        <div id="countMaint" class="num">0</div>
        <div class="label">×ª×—×–×•×§×”</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="controls-row">
        <div class="seg">
          <button data-filter="all" class="active">×”×›×œ</button>
          <button data-filter="purchased">×”×ª×‘×¦×¢×” ×¢×¡×§×”</button>
          <button data-filter="not">×œ× ×”×ª×‘×¦×¢×” ×¢×¡×§×”</button>
        </div>
        <div class="search-box">
          <input id="searchInput" class="input" placeholder="×—×™×¤×•×© ××¡×¤×¨ ×˜××‘×œ×˜..." />
        </div>
      </div>
      <div id="status" class="status">××ª×—×‘×¨â€¦</div>
    </div>

    <!-- Cards -->
    <div class="cards-container">
      <div id="cards" class="cards">
        <div class="loading">
          ×˜×•×¢×Ÿ ×˜××‘×œ×˜×™×...
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ××•×“×œ ×ª×—×–×•×§×” -->
<div id="maintModal" class="overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>××¦×‘ ×ª×—×–×•×§×”</h2>
      <button id="maintClose" class="modal-close">Ã—</button>
    </div>
    <p style="color:var(--muted); margin-bottom:16px">××¦×‘ ×ª×—×–×•×§×” ××¡×ª×™×¨ ×˜××‘×œ×˜ ××”×¨×©×™××” ×”×¨××©×™×ª ×•×œ× ×¡×•×¤×¨×™× ××•×ª×•.</p>
    <div id="maintPinWrap" class="stack" style="margin-bottom:16px">
      <input id="maintPin" inputmode="numeric" maxlength="4" class="input" placeholder="×”×›× ×¡ ×§×•×“ PIN" />
      <button id="maintPinOk" class="btn primary">×›× ×™×¡×”</button>
      <div style="color:var(--muted); font-size:12px; text-align:center">×‘×¨×™×¨×ª ××—×“×œ: 4321</div>
    </div>
    <div id="maintBody" style="display:none">
      <input id="maintSearch" class="input" placeholder="×—×™×¤×•×© ××¡×¤×¨ ×˜××‘×œ×˜" style="margin-bottom:16px" />
      <div id="maintCards" class="cards"></div>
    </div>
  </div>
</div>

<!-- ××•×“×œ ××™×©×•×¨ -->
<div id="confirmModal" class="overlay">
  <div class="modal">
    <h3 style="margin:0 0 16px;font-size:18px">×œ×‘×˜×œ ×¢×¡×§×” ×¢×‘×•×¨ ×˜××‘×œ×˜ ×–×”?</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
      <button id="confirmToUnused" class="btn danger">×‘×˜×œ ×¢×¡×§×”</button>
      <button id="confirmCancel" class="btn outline">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- ××•×“×œ ×¢×–×¨×” -->
<div id="helpModal" class="overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>××™×š ×¢×•×‘×“×™×?</h2>
      <button id="helpClose" class="modal-close">Ã—</button>
    </div>
    <ol style="margin:0 0 20px 0; padding: 0 20px; font-size:14px; color:var(--muted); line-height:1.6">
      <li>×”×¨×©×™××” ×›×•×œ×œ×ª ××ª ×”×˜××‘×œ×˜×™× #51â€“#99 ×‘×œ×‘×“.</li>
      <li>×›×“×™ ×œ×¡××Ÿ ×¢×¡×§×”: ×œ×—×¥ ×¢×œ <b>×¡××Ÿ ×›×”×ª×‘×¦×¢×” ×¢×¡×§×”</b>. ××¤×©×¨ ×œ×¤×œ×˜×¨ ×œ×¤×™ ×”×ª×‘×¦×¢×”/×œ×.</li>
      <li>×›×“×™ ×œ×‘×˜×œ ×¢×¡×§×”: ×œ×—×¥ <b>×¡××Ÿ ×›×œ× ×”×ª×‘×¦×¢×” ×¢×¡×§×”</b> ×•×ª×•×¤×™×¢ ×‘×§×©×ª ××™×©×•×¨.</li>
      <li>×›×“×™ ×œ×”×›× ×™×¡/×œ×”×•×¦×™× ××ª×—×–×•×§×”: ×¤×ª×— <b>××¦×‘ ×ª×—×–×•×§×”</b> (×¢× PIN).</li>
      <li>×›×“×™ ×œ××¤×¡ ××ª ×”×™×•×: <b>××™×¤×•×¡ ×™×•×</b> (×¢× PIN).</li>
    </ol>
    <button id="helpClose2" class="btn primary" style="width:100%">×”×‘× ×ª×™</button>
  </div>
</div>

<!-- ×‘×× ×¨ ×©×’×™××” -->
<div id="errorBanner" class="error-banner"></div>

<script type="module">
  const errorBanner=document.getElementById('errorBanner');
  function showError(msg){ 
    errorBanner.textContent=msg; 
    errorBanner.style.display='block'; 
    setTimeout(()=>errorBanner.style.display='none',7000); 
  }
  window.addEventListener('error',(e)=>showError(e.message||'×©×’×™××” ×›×œ×œ×™×ª'));
  window.addEventListener('unhandledrejection',(e)=>showError(e.reason?.message||'×©×’×™××” ×›×œ×œ×™×ª'));

  const DEFAULT_CONFIG = { firebase: {"apiKey": "AIzaSyAAZvh7mH9z7Se1uUwIJg9G4bOEf9oD5Ec", "authDomain": "tablets-tracker-835e3.firebaseapp.com", "projectId": "tablets-tracker-835e3", "storageBucket": "tablets-tracker-835e3.firebasestorage.app", "messagingSenderId": "774676558822", "appId": "1:774676558822:web:b008720d77026be5d1dc27", "measurementId": "G-W4S6LFF6G5"}, orgId: "main" };
  let cfg = DEFAULT_CONFIG;
  const RESET_PIN='4321';
  const RANGE_START=51, RANGE_END=99;
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const statusEl=document.getElementById('status');

  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
  const { getAuth, signInAnonymously, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js');
  const { getFirestore, doc, getDocs, updateDoc, collection, onSnapshot, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');

  const app = initializeApp(cfg.firebase);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const todayISO=()=>{ const d=new Date(); const tz=d.getTimezoneOffset(); return new Date(d - tz*60000).toISOString().slice(0,10); };
  const today=todayISO();
  const dayCol = collection(db,'orgs', cfg.orgId, 'days', today, 'tablets');
  const dayDoc = (id)=> doc(db,'orgs', cfg.orgId, 'days', today, 'tablets', String(id));

  let unsubscribe=null; let cache=new Map();

  async function ensureToday(){
    const snap=await getDocs(dayCol);
    if (!snap.empty) return;
    const batch=writeBatch(db);
    for (let n=RANGE_START; n<=RANGE_END; n++){ batch.set(dayDoc(n), { status:'unused', updatedAt: Date.now() }); }
    await batch.commit();
  }

  function recalcCounters(){
    let purchased=0, maint=0, unused=0;
    for (const [,v] of cache){ if(v.status==='purchased') purchased++; else if(v.status==='maint') maint++; else unused++; }
    document.getElementById('countPurchased').textContent=purchased;
    document.getElementById('countMaint').textContent=maint;
    document.getElementById('countUnused').textContent=unused;
  }

  function setActiveFilter(val){ $$('.seg button').forEach(b=>b.classList.toggle('active', b.dataset.filter===val)); }

  function render(){
    const activeBtn=document.querySelector('.seg button.active'); 
    const filter=(activeBtn?activeBtn.dataset.filter:'all');
    const search=document.getElementById('searchInput').value.trim().toLowerCase();
    const container=document.getElementById('cards'); 
    
    // Clear loading state
    container.innerHTML='';
    
    const entries=[...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0]));
    let hasVisibleCards = false;
    
    for (const [id, info] of entries){
      if (info.status==='maint') continue;
      const pass=(filter==='all')||(filter==='purchased'&&info.status==='purchased')||(filter==='not'&&info.status==='unused');
      const match=!search || String(id).includes(search);
      if (!pass || !match) continue;
      
      hasVisibleCards = true;
      const cls=(info.status==='purchased')?'purchased':'unused';
      const chip=(cls==='purchased')?'<span class="chip green">×”×ª×‘×¦×¢×” ×¢×¡×§×”</span>':'<span class="chip gray">×œ× ×”×ª×‘×¦×¢×” ×¢×¡×§×”</span>';
      const card=document.createElement('div'); 
      card.className='card '+cls;
      card.innerHTML=`
        <div class="card-header">
          <div class="card-title">#${id}</div>
          ${chip}
        </div>
        <div class="card-actions">
          <button class="btn primary btnStatus" data-id="${id}" data-next="purchased">×¡××Ÿ ×›×”×ª×‘×¦×¢×” ×¢×¡×§×”</button>
          <button class="btn outline btnStatus" data-id="${id}" data-next="unused">×¡××Ÿ ×›×œ× ×”×ª×‘×¦×¢×” ×¢×¡×§×”</button>
        </div>`;
      container.appendChild(card);
    }
    
    if (!hasVisibleCards) {
      container.innerHTML = `
        <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--muted)">
          <div style="font-size:48px; margin-bottom:16px">ğŸ“±</div>
          <div style="font-size:18px; margin-bottom:8px">×œ× × ××¦××• ×˜××‘×œ×˜×™×</div>
          <div style="font-size:14px">× ×¡×” ×œ×©× ×•×ª ××ª ×”×¤×™×œ×˜×¨ ××• ×”×—×™×¤×•×©</div>
        </div>
      `;
    }
    
    container.querySelectorAll('.btnStatus').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id=e.currentTarget.getAttribute('data-id');
        const next=e.currentTarget.getAttribute('data-next');
        const current=(cache.get(id)?.status||'unused');
        if (current==='purchased' && next==='unused'){ openConfirm(id); return; }
        try{ await updateDoc(dayDoc(id), { status: next, updatedAt: Date.now() }); }catch(err){ showError('×¢×“×›×•×Ÿ × ×›×©×œ'); }
      });
    });
  }

  let confirmId=null;
  function openConfirm(id){ confirmId=id; document.getElementById('confirmModal').classList.add('show'); }
  document.getElementById('confirmCancel').addEventListener('click', ()=> document.getElementById('confirmModal').classList.remove('show'));
  document.getElementById('confirmToUnused').addEventListener('click', async ()=>{ if(!confirmId) return; try{ await updateDoc(dayDoc(confirmId), { status:'unused', updatedAt: Date.now() }); }catch{} document.getElementById('confirmModal').classList.remove('show'); confirmId=null; });

  async function subscribe(){
    if (unsubscribe) unsubscribe();
    statusEl.textContent='×˜×•×¢×Ÿ ××ª ×”×™×•×â€¦';
    await ensureToday();
    unsubscribe=onSnapshot(dayCol, (snap)=>{
      const map=new Map(); snap.forEach(s=>{ const d=s.data(); map.set(s.id, { status:d.status||'unused' }); });
      cache=map; statusEl.textContent=`××—×•×‘×¨ â€” ${map.size} ×˜××‘×œ×˜×™×`; recalcCounters(); render();
    }, (err)=>{ console.error(err); statusEl.textContent='×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨.'; showError('×©×’×™××” ×‘-Firestore'); });
  }

  function exportCSV(){
    const t=new Date().toISOString().slice(0,10);
    const rows=[["date","tablet","status"]];
    for (const [id, info] of [...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0])) ) rows.push([t,id,info.status]);
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`tablet-tracker-${t}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  async function resetDay(){
    const pin=prompt('×”×›× ×¡ PIN:'); if(pin!=='4321'){ alert('PIN ×©×’×•×™'); return; }
    if(!confirm('×œ××¤×¡ ××ª ×”×™×•× ×œ×›×œ ×”×˜××‘×œ×˜×™×?')) return;
    try{ const snap=await getDocs(dayCol); const { writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
      const batch=writeBatch(db); snap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await ensureToday(); alert('×”××™×¤×•×¡ ×”×•×©×œ×.'); }
    catch(e){ showError('×”××™×¤×•×¡ × ×›×©×œ'); }
  }

  function openMaint(){ document.getElementById('maintModal').classList.add('show'); document.getElementById('maintPinWrap').style.display='block'; document.getElementById('maintBody').style.display='none'; }
  function closeMaint(){ document.getElementById('maintModal').classList.remove('show'); }
  document.getElementById('maintClose').addEventListener('click', closeMaint);
  document.getElementById('maintPinOk').addEventListener('click', ()=>{ const val=document.getElementById('maintPin').value.trim();
    if(val!=='4321'){ alert('PIN ×©×’×•×™'); return; } document.getElementById('maintPinWrap').style.display='none'; document.getElementById('maintBody').style.display='block'; renderMaint(); });

  function renderMaint(){
    const q=document.getElementById('maintSearch').value.trim().toLowerCase();
    const cont=document.getElementById('maintCards'); cont.innerHTML='';
    const entries=[...cache.entries()].sort((a,b)=>Number(a[0])-Number(b[0]));
    for (const [id, info] of entries){
      if (q && !String(id).includes(q)) continue;
      const cls=(info.status==='maint')?'maint':'unused';
      const card=document.createElement('div'); card.className='card '+cls;
      card.innerHTML=`
        <div class="card-header">
          <div class="card-title">#${id}</div>
          <button class="btn btnMaintToggle" data-id="${id}">${info.status==='maint'?'×”×¡×¨ ×ª×—×–×•×§×”':'×”×›× ×¡ ×œ×ª×—×–×•×§×”'}</button>
        </div>
        <div style="color:var(--muted); font-size:14px">${info.status==='maint'?'ğŸ›  ×‘××¦×‘ ×ª×—×–×•×§×”':'â€”'}</div>`;
      cont.appendChild(card);
    }
    cont.querySelectorAll('.btnMaintToggle').forEach(b=>{ b.addEventListener('click', async (e)=>{
      const id=e.currentTarget.getAttribute('data-id'); const curr=(cache.get(id)?.status||'unused'); const next=(curr==='maint')?'unused':'maint';
      try{ await updateDoc(dayDoc(id), { status: next, updatedAt: Date.now() }); }catch{ showError('×¢×“×›×•×Ÿ × ×›×©×œ'); }
    }); });
    document.getElementById('maintSearch').oninput=renderMaint;
  }

  // Event Listeners
  $$('.seg button').forEach(b=>b.addEventListener('click',()=>{ setActiveFilter(b.dataset.filter); render(); }));
  document.getElementById('searchInput').addEventListener('input', render);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnReset').addEventListener('click', resetDay);
  document.getElementById('btnMaint').addEventListener('click', openMaint);
  document.getElementById('btnHelp').addEventListener('click', ()=>document.getElementById('helpModal').classList.add('show'));
  document.getElementById('helpClose').addEventListener('click', ()=>document.getElementById('helpModal').classList.remove('show'));
  document.getElementById('helpClose2').addEventListener('click', ()=>document.getElementById('helpModal').classList.remove('show'));

  onAuthStateChanged(auth, async (user)=>{ if(!user){ statusEl.textContent='××ª×—×‘×¨â€¦'; await signInAnonymously(auth); return; } subscribe(); });
</script>
</body>
</html>
